<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feast POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- ELEGANT THEME VARIABLES --- */
        :root {
            --primary: #1e293b;
            --primary-light: #334155;
            --accent: #d97706;
            --bg: #f8fafc;
            --white: #ffffff;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --veg-color: #15803d;
            --nonveg-color: #b91c1c;
            --exp-header: #be123c;
            --inv-box-bg: #fff7ed;
            --inv-box-border: #fdba74;
            --font-heading: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background-color: var(--bg); color: var(--text-dark); height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--primary); height: 100%; display: flex; flex-direction: column; padding: 25px 20px; z-index: 10; flex-shrink: 0; color: white; box-shadow: 4px 0 20px rgba(0,0,0,0.05); }
        .brand { font-family: var(--font-heading); font-size: 26px; font-weight: 700; color: var(--white); margin-bottom: 50px; display: flex; align-items: center; gap: 12px; letter-spacing: 1px; }
        .brand i { color: var(--accent); }
        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .nav-item { padding: 14px 18px; border-radius: 8px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 14px; font-weight: 500; transition: all 0.3s ease; font-size: 14px; letter-spacing: 0.5px; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
        .nav-item.active { background: var(--accent); color: var(--white); box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3); font-weight: 700; }
        .newsletter-box { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; text-align: center; margin-top: auto; border: 1px solid rgba(255,255,255,0.1); }
        .newsletter-box h4 { margin-bottom: 5px; font-family: var(--font-heading); letter-spacing: 1px; }
        .newsletter-box p { font-size: 11px; opacity: 0.6; margin-bottom: 15px; }
        .btn-white { background: var(--white); color: var(--primary); border: none; padding: 10px 16px; border-radius: 6px; font-weight: 700; width: 100%; cursor: pointer; font-size: 12px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- LAYOUT --- */
        .main-area { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        .content-wrapper { flex: 1; overflow: hidden; display: flex; position: relative; }
        #view-sales { display: flex; width: 100%; height: 100%; }

        .pos-grid-area { flex: 1; overflow-y: auto; padding-right: 0; display: flex; flex-direction: column; background-color: var(--bg); }

        /* FIXED: Right Sidebar Layout */
        .pos-cart-area {
            width: 380px;
            background: var(--white);
            border-left: 1px solid var(--border);
            height: 100%;
            flex-shrink: 0;
            z-index: 5;
            position: relative; /* Essential for absolute children */
            overflow: hidden;   /* Hide the sliding panel */
            box-shadow: -5px 0 20px rgba(0,0,0,0.02);
        }

        /* --- TOP BAR --- */
        .top-bar { padding: 20px 30px; background: var(--bg); display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-shrink: 0; }
        .search-box { position: relative; flex: 1; max-width: 450px; }
        .search-box input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 8px; border: 1px solid #cbd5e1; background: var(--white); font-size: 14px; box-shadow: var(--shadow); transition: 0.2s; font-family: var(--font-body); }
        .search-box input:focus { border-color: var(--accent); outline: none; }
        .search-box i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-light); }

        .diet-toggles { display: flex; gap: 10px; background: var(--white); padding: 5px; border-radius: 8px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .diet-btn { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; cursor: pointer; font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 6px; transition: all 0.2s; color: var(--text-light); letter-spacing: 0.5px; text-transform: uppercase; font-family: var(--font-body); }
        .diet-btn i { font-size: 8px; }
        .diet-btn.veg.active { background-color: #dcfce7; color: var(--veg-color); }
        .diet-btn.nonveg.active { background-color: #fee2e2; color: var(--nonveg-color); }
        .diet-btn:hover { background-color: #f1f5f9; }

        /* --- CATEGORY TABS --- */
        .cat-tabs { display: flex; gap: 12px; flex-wrap: wrap; padding: 10px 30px; flex-shrink: 0; background: var(--bg); }
        .cat-tab { min-width: 90px; height: 45px; padding: 0 15px; border: 1px solid var(--border); border-radius: 30px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; background: var(--white); transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .cat-tab:hover { transform: translateY(-1px); border-color: var(--accent); color: var(--accent); }
        .cat-tab.active { background: var(--primary); color: var(--white); border-color: var(--primary); box-shadow: 0 4px 10px rgba(30, 41, 59, 0.2); }
        .cat-tab i { font-size: 14px; margin: 0; }
        .cat-tab span { font-size: 11px; font-weight: 700; white-space: nowrap; letter-spacing: 0.5px; text-transform: uppercase; }

        /* --- ITEM CARDS --- */
        .items-scroll-area { flex: 1; overflow-y: auto; padding: 10px 30px 30px 30px; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 20px; padding-bottom: 50px; }
        .item-card { background: var(--white); border-radius: 12px; padding: 16px; border: 1px solid transparent; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; box-shadow: var(--shadow); }
        .item-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border-color: var(--border); }
        .diet-dot { position: absolute; top: 12px; right: 12px; width: 8px; height: 8px; border-radius: 50%; }
        .diet-dot.veg { background-color: var(--veg-color); box-shadow: 0 0 0 2px #dcfce7; }
        .diet-dot.nonveg { background-color: var(--nonveg-color); box-shadow: 0 0 0 2px #fee2e2; }
        .item-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 3px solid var(--white); }
        .item-title { font-family: var(--font-heading); font-weight: 700; font-size: 14px; margin-bottom: 6px; line-height: 1.3; color: var(--text-dark); }
        .item-desc { font-size: 11px; color: var(--text-light); margin-bottom: 15px; height: 32px; overflow: hidden; font-style: italic; }
        .item-footer { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: auto; padding-top: 10px; border-top: 1px dashed var(--border); }
        .item-price { font-weight: 800; font-size: 15px; color: var(--primary); }
        .add-btn { width: 32px; height: 32px; border-radius: 10px; background: var(--bg); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .add-btn:hover { background: var(--primary); color: var(--white); border-color: var(--primary); }

        /* --- RIGHT CART (Sliding Panels) --- */
        .right-panel-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; background: white; z-index: 10;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #cartPanel { z-index: 20; transform: translateX(0); }
        #checkoutPanel { z-index: 30; transform: translateX(100%); }
        .pos-cart-area.show-checkout #cartPanel { transform: translateX(-20%); opacity: 0.5; }
        .pos-cart-area.show-checkout #checkoutPanel { transform: translateX(0); }
        .cart-header { padding: 25px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: white; }
        .cart-title { font-family: var(--font-heading); font-size: 18px; font-weight: 700; color: var(--primary); letter-spacing: 0.5px; }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px 30px; display: flex; flex-direction: column; gap: 15px; background: white; }
        .cart-item { display: flex; align-items: center; gap: 12px; background: var(--bg); padding: 10px; border-radius: 12px; border: 1px solid transparent; transition: 0.2s; }
        .cart-item:hover { border-color: var(--border); background: white; box-shadow: var(--shadow); }
        .cart-thumb { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }
        .cart-details { flex: 1; }
        .cart-name { font-size: 13px; font-weight: 700; line-height: 1.3; color: var(--text-dark); }
        .cart-price { font-size: 12px; color: var(--text-light); font-weight: 500; }
        .cart-qty { display: flex; align-items: center; gap: 8px; background: var(--white); padding: 3px 8px; border-radius: 6px; border: 1px solid var(--border); }
        .qty-btn { width: 20px; height: 20px; border-radius: 4px; border: none; background: transparent; color: var(--primary); cursor: pointer; font-weight: bold; }
        .qty-btn:hover { background: var(--bg); }
        .cart-footer { padding: 30px; border-top: 1px solid var(--border); background: var(--white); z-index: 10; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; color: var(--text-light); font-weight: 500; }
        .summary-total { display: flex; justify-content: space-between; margin-top: 15px; font-size: 18px; font-weight: 800; color: var(--primary); border-top: 1px dashed var(--border); padding-top: 15px; font-family: var(--font-heading); }
        .checkout-scroll-content { flex: 1; overflow-y: auto; padding: 30px; }
        .co-input-group { margin-bottom: 20px; }
        .co-input { background: var(--white); }
        .co-back-btn { background: none; border: none; font-size: 13px; font-weight: 700; color: var(--text-light); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .checkout-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 13px; margin-top: 20px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2); text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-body); }
        .checkout-btn:hover { background: var(--accent); }

        /* --- GENERIC VIEWS --- */
        .generic-view { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 30px; }
        .generic-view.active { display: block; }
        .card-panel { background: white; border-radius: 12px; padding: 30px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: var(--shadow); }
        h2.panel-title { font-family: var(--font-heading); font-size: 22px; font-weight: 700; margin-bottom: 25px; color: var(--primary); letter-spacing: 0.5px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; outline: none; background: var(--bg); transition: 0.2s; font-size: 14px; font-family: var(--font-body); }
        input:focus, select:focus { border-color: var(--accent); background: white; }
        label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-dark); letter-spacing: 0.5px; text-transform: uppercase; }

        .inventory-box { background-color: var(--inv-box-bg); border: 1px dashed var(--inv-box-border); padding: 20px; border-radius: 10px; margin-top: 10px; display: none; }
        .inv-title { color: #c2410c; font-weight: 700; font-size: 13px; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .auto-calc-note { font-size: 11px; color: #475569; margin-top: 8px; display: flex; align-items: center; gap: 5px; font-style: italic; }

        .exp-table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 13px; border-radius: 8px; overflow: hidden; }
        .exp-table th { text-align: left; padding: 15px; background: var(--exp-header); color: white; font-size: 11px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .exp-table td { padding: 15px; border-bottom: 1px solid var(--border); color: var(--text-dark); background: white; }
        .exp-table tr:hover td { background-color: #fff1f2; }

        .col-amount { font-weight: 700; color: #059669; }
        .col-inv { color: #d97706; font-weight: 600; }
        .btn-save { background: var(--exp-header); color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; margin-top: 20px; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-save:hover { background: #e11d48; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3); }
        .btn-load { background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: 700; cursor: pointer; height: 42px; display: flex; align-items: center; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-action { background: #cbd5e1; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; border: none; cursor: pointer; color: #475569; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { text-align: left; padding: 15px; background: #f1f5f9; color: var(--text-dark); font-size: 11px; text-transform: uppercase; font-weight: 700; border-radius: 8px 8px 0 0; letter-spacing: 0.5px; }
        td { padding: 15px; border-bottom: 1px solid var(--border); color: var(--text-light); }
        tr:last-child td { border-bottom: none; }
        .btn-sm { padding: 8px 16px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-sec { background: var(--bg); color: var(--text-dark); border: 1px solid var(--border); }

        /* --- INVENTORY SUB-TABS --- */
        .inventory-sub-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 25px; }
        .inv-tab-btn { padding: 10px 20px; border-radius: 30px; border: 1px solid transparent; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-light); transition: 0.2s; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .inv-tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(30,41,59,0.2); }
        .inv-content-area { display: none; }
        .inv-content-area.active { display: block; }
        .warn-text { color: #dc2626; font-weight: bold; }
        .good-text { color: #16a34a; font-weight: bold; }

        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .stat-box { background: white; padding: 25px; border-radius: 12px; border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow); transition: 0.3s; }
        .stat-box:hover { transform: translateY(-3px); border-color: var(--accent); }
        .stat-num { font-family: var(--font-heading); font-size: 32px; font-weight: 700; color: var(--primary); margin-top: 8px; }
        .stat-label { font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* --- RECEIPT MODAL --- */
        .receipt-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .receipt-paper { background: #fff; width: 340px; padding: 25px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); font-family: 'Courier New', monospace; position: relative; }
        .r-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .r-title { font-weight: 900; font-size: 18px; text-transform: uppercase; }
        .r-meta { font-size: 11px; color: #333; margin-top: 5px; }
        .r-body { font-size: 12px; margin-bottom: 15px; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .r-divider { border-bottom: 1px dashed #000; margin: 10px 0; }
        .r-total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-top: 5px; }
        .r-footer { text-align: center; font-size: 10px; margin-top: 15px; color: #555; }
        .r-actions { display: flex; gap: 10px; margin-top: 20px; }
        .r-btn { flex: 1; padding: 10px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .r-print { background: #000; color: #fff; }
        .r-close { background: #eee; color: #000; }

        /* Report Table */
        .report-table-wrapper { margin-top: 20px; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .report-table th { text-align: left; padding: 12px; background: #f1f5f9; color: var(--text-light); font-weight: 600; }
        .report-table td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text-dark); }
        .report-date-header { background-color: #e2e8f0; font-weight: bold; color: var(--primary); }

        @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .pos-cart-area { display: none; } }
        @media print { .sidebar, .main-area { display: none !important; } .receipt-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex !important; justify-content: center; align-items: flex-start; padding-top: 20px; backdrop-filter: none; z-index: 9999; } .receipt-paper { box-shadow: none; border: 1px solid #000; } .r-actions { display: none !important; } }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="brand"><i class="fas fa-utensils"></i> Feast</div>
    <div class="nav-links">
        <div class="nav-item active" onclick="showTab('sales')"><i class="fas fa-home"></i> Home (POS)</div>
        <div class="nav-item" onclick="showTab('inventory')"><i class="fas fa-box"></i> Inventory</div>
        <div class="nav-item" onclick="showTab('expenses')"><i class="fas fa-wallet"></i> Expenses</div>
        <div class="nav-item" onclick="showTab('reports')"><i class="fas fa-chart-line"></i> Reports</div>
    </div>
</div>

<!-- MAIN AREA -->
<div class="main-area">

    <!-- Tab 1: SALES -->
    <div id="view-sales" class="content-wrapper">
        <div class="pos-grid-area">
            <div class="top-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="search" id="posSearch" placeholder="Search menu..." onkeyup="filterMenu()">
                </div>
                <div class="diet-toggles">
                    <button class="diet-btn veg" id="btnVeg" onclick="toggleDiet('veg')"><i class="fas fa-circle"></i> VEG</button>
                    <button class="diet-btn nonveg" id="btnNonVeg" onclick="toggleDiet('nonveg')"><i class="fas fa-circle"></i> NON-VEG</button>
                </div>
            </div>
            <div class="cat-tabs" id="catTabs"></div>
            <div class="items-scroll-area">
                <h3 style="margin: 0 0 20px 0; font-family: var(--font-heading); font-weight: 700; font-size: 20px; color: var(--primary); letter-spacing: 0.5px;">Choose Items</h3>
                <div class="items-grid" id="menuGrid"></div>
            </div>
        </div>

        <div class="pos-cart-area">
            <div id="cartPanel" class="right-panel-view">
                <div class="cart-header">
                    <div class="cart-title">Current Order</div>
                    <div style="font-size: 11px; background: var(--bg); padding: 6px 10px; border-radius: 20px; color: var(--text-light); font-weight: 600;">#NEW</div>
                </div>
                <div class="cart-items" id="cartItems">
                    <div style="text-align:center; color: #cbd5e1; margin-top: 80px;">
                        <i class="fas fa-utensils" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i><br>Start adding items
                    </div>
                </div>
                <div class="cart-footer">
                    <div class="summary-line"><span>Sub Total</span><span id="cart-subtotal">₹0.00</span></div>
                    <div class="summary-line"><span>Tax (5%)</span><span id="cart-tax">₹0.00</span></div>
                    <div class="summary-line"><span>Round Off</span><span id="cart-round">0.00</span></div>
                    <div class="summary-total"><span>Total</span><span id="cart-total">₹0.00</span></div>
                    <button class="checkout-btn" onclick="showCheckout()">Place Order</button>
                </div>
            </div>

            <div id="checkoutPanel" class="right-panel-view hidden">
                <div class="cart-header">
                    <button class="co-back-btn" onclick="hideCheckout()"><i class="fas fa-arrow-left"></i> Back</button>
                    <div class="cart-title" style="font-size: 18px;">Checkout</div>
                </div>
                <div class="checkout-scroll-content">
                    <div class="co-input-group"><label class="co-label">Customer Name</label><input type="text" class="co-input" id="custName" placeholder="e.g. John Doe"></div>
                    <div class="co-input-group"><label class="co-label">Mobile Number</label><input type="tel" class="co-input" id="custMobile" placeholder="e.g. 9999999999"></div>
                    <div class="co-input-group"><label class="co-label">Order Type</label><select class="co-input" id="orderType"><option value="Dine-in">Dine-in</option><option value="Takeaway">Takeaway</option><option value="Delivery">Delivery</option></select></div>
                    <div class="co-input-group"><label class="co-label">Payment Mode</label><select class="co-input" id="paymentMode"><option value="Cash">Cash</option><option value="UPI">UPI / QR Code</option><option value="Card">Card</option></select></div>
                    <div class="co-input-group"><label class="co-label">Discount (₹)</label><input type="number" class="co-input" id="discount" value="0" oninput="updateCart()"></div>
                </div>
                <div class="cart-footer">
                    <div style="font-size: 13px; color: var(--text-light); text-align: right; margin-bottom: 5px;">Total Payable</div>
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary); text-align: right; font-family: var(--font-heading);" id="final-payable">₹0.00</div>
                    <button class="checkout-btn" onclick="submitOrder()">Confirm & Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: INVENTORY -->
    <div id="view-inventory" class="generic-view">
        <h2 class="panel-title">Inventory Management</h2>
        <div class="inventory-sub-tabs">
            <button class="inv-tab-btn active" onclick="showInvTab('audit')">Stock Audit</button>
            <button class="inv-tab-btn" onclick="showInvTab('waste')">Wastage Log</button>
            <button class="inv-tab-btn" onclick="showInvTab('mapping')">Recipe Mapping</button>
        </div>

        <!-- 1. Stock Audit -->
        <div id="inv-audit" class="inv-content-area active">
            <div class="card-panel">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newItemName" placeholder="New Item Name">
                    <select id="newItemUnit" style="width: 100px;"><option>KG</option><option>GM</option><option>PC</option></select>
                    <button class="btn-sm" style="background: var(--primary); color: white;" onclick="createNewItem()">+ Add</button>
                    <button class="btn-sm btn-sec" style="margin-left: auto;" onclick="loadInventory()">Refresh</button>
                </div>
                <table id="inventoryTable"><thead><tr><th>ID</th><th>Name</th><th>Unit</th><th>System Stock</th><th>Physical Count</th><th>Variance</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <!-- 2. Wastage -->
        <div id="inv-waste" class="inv-content-area">
            <div class="card-panel">
                <h3>Log Waste</h3>
                <div class="form-grid">
                    <div><label>Date</label><input type="date"></div>
                    <div><label>Item</label><select><option>Tomato</option></select></div>
                    <div><label>Qty</label><input type="number" placeholder="0.0"></div>
                </div>
                <button class="btn-save">Save Log</button>
            </div>
        </div>

        <!-- 3. Mapping -->
        <div id="inv-mapping" class="inv-content-area">
            <div class="card-panel">
                <h3>Recipe Mapping</h3>
                <p style="font-size:13px; color:#666;">Link Menu Items to Raw Materials here.</p>
            </div>
        </div>
    </div>

    <!-- TAB 3: EXPENSES -->
    <div id="view-expenses" class="generic-view">
        <h2 class="panel-title">+ Record Expense</h2>
        <div class="card-panel">
            <form id="expenseForm">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr 1fr;">
                    <div><label>Date</label><input type="date" id="expDate"></div>
                    <div><label>Category</label><select id="expCategory" onchange="toggleInvFields()"><option>Rent</option><option>Salary</option><option>Electricity</option><option value="Inventory">Inventory (Raw Materials)</option><option>Misc</option></select></div>
                    <div><label>Description / Item Name</label><input type="text" id="expDesc" placeholder="e.g. Monthly Rent or 'Tomato'"></div>
                    <div><label>Amount (₹)</label><input type="number" id="expAmount" placeholder="0.00"></div>
                </div>
                <div id="invFields" class="inventory-box">
                    <span class="inv-title">Inventory Details</span>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div><label>Quantity</label><input type="number" id="invQty" placeholder="0" oninput="calcExp()"></div>
                        <div><label>Unit</label><select id="invUnit"><option>Kg</option><option>Gm</option><option>Packets</option><option>Litre</option><option>Pcs</option></select></div>
                        <div><label>Rate per Unit (₹)</label><input type="number" id="invRate" placeholder="0.00" oninput="calcExp()"></div>
                    </div>
                    <div class="auto-calc-note"><i class="fas fa-info-circle"></i> Amount will be calculated automatically: Quantity × Rate</div>
                </div>
                <button type="submit" class="btn-save">Save Expense</button>
            </form>
        </div>
        <div class="card-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: flex-end;">
                <div style="display: flex; gap: 15px;">
                    <div><label>From Date</label><input type="date" id="expFrom"></div>
                    <div><label>To Date</label><input type="date" id="expTo"></div>
                </div>
                <button class="btn-load" onclick="loadExpenses()">Load Expenses</button>
            </div>
            <table class="exp-table" id="expensesTable"><thead><tr><th>Date</th><th>Category / Item</th><th>Description</th><th>Amount (₹)</th><th>Inv. Qty</th><th>Inv. Cost</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- TAB 4: REPORTS -->
    <div id="view-reports" class="generic-view">
        <h2 class="panel-title">Monthly P&L</h2>
        <div class="stats-row">
            <div class="stat-box"><div class="stat-label">Sales</div><div class="stat-num" style="color: #059669;" id="repSales">₹0</div></div>
            <div class="stat-box"><div class="stat-label">Expenses</div><div class="stat-num" style="color: #dc2626;" id="repExp">₹0</div></div>
            <div class="stat-box"><div class="stat-label">Net Profit</div><div class="stat-num" id="repProfit">₹0</div></div>
        </div>
        <div class="card-panel">
            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px;">
                <div style="flex:1"><label>From</label><input type="date" id="repFrom"></div>
                <div style="flex:1"><label>To</label><input type="date" id="repTo"></div>
                <button class="checkout-btn" style="width: auto; padding: 12px 30px; margin: 0;" onclick="loadReport()">Generate</button>
            </div>
            <div id="detailed-report-container"></div>
        </div>
    </div>

</div>

<!-- RECEIPT MODAL -->
<div class="receipt-modal-overlay" id="receiptModal">
    <div class="receipt-paper">
        <div class="r-header">
            <div class="r-title" style="font-family: var(--font-heading);">Bites Restaurant</div>
            <div style="font-size: 11px; color: #333; margin-top: 5px;">Jamshedpur, India</div>
            <div style="font-size: 11px; color: #333; margin-top: 5px;" id="r-date"></div>
            <div style="font-size: 11px; color: #333;" id="r-order-no"></div>
            <div style="font-size: 11px; color: #333;" id="r-cust"></div>
        </div>
        <div style="font-size: 12px; margin-bottom: 15px;" id="r-items"></div>
        <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;"><span>Subtotal</span><span id="r-sub">0.00</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;"><span>Tax (5%)</span><span id="r-tax">0.00</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;"><span>Round Off</span><span id="r-round">0.00</span></div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-top: 5px;"><span>TOTAL</span><span id="r-total" style="font-size:16px;">0.00</span></div>
        <div style="text-align: center; font-size: 10px; margin-top: 15px; color: #555;">Thank you for dining with us!<br>Visit Again</div>
        <div class="r-actions">
            <button class="r-btn r-close" onclick="closeReceipt()">Close</button>
            <button class="r-btn r-print" onclick="window.print()">Print</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';

    // --- DATA ---
    const MENU_DB = [
        { cat: "Snacks", name: "French Fries", rate: 80, img: "https://placehold.co/100x100/ffa500/fff?text=Fries" },
        { cat: "Snacks", name: "Cheese Balls (8pcs)", rate: 160, img: "https://placehold.co/100x100/ffcc00/fff?text=ChzBalls" },
        { cat: "Snacks", name: "Masala Cheese Balls", rate: 180, img: "https://placehold.co/100x100/ff6600/fff?text=Masala" },
        { cat: "Snacks", name: "Potato Twister", rate: 60, img: "https://placehold.co/100x100/cc9900/fff?text=Twister" },
        { cat: "Snacks", name: "Paneer Pakoda", rate: 80, img: "https://placehold.co/100x100/ff9966/fff?text=Pakoda" },
        { cat: "Snacks", name: "Veg Pakoda", rate: 40, img: "https://placehold.co/100x100/009933/fff?text=VegPak" },
        { cat: "Snacks", name: "Chicken Pakoda", rate: 100, img: "https://placehold.co/100x100/cc3300/fff?text=ChkPak" },
        { cat: "Soup", name: "Hot & Sour Soup (Veg)", rate: 50, img: "https://placehold.co/100x100/cc3300/fff?text=VegSoup" },
        { cat: "Soup", name: "Hot & Sour Soup (Chicken)", rate: 70, img: "https://placehold.co/100x100/cc3300/fff?text=ChkSoup" },
        { cat: "Soup", name: "Sweet Corn Soup (Veg)", rate: 50, img: "https://placehold.co/100x100/ffcc00/fff?text=CornVeg" },
        { cat: "Soup", name: "Sweet Corn Soup (Chicken)", rate: 70, img: "https://placehold.co/100x100/ffcc00/fff?text=CornChk" },
        { cat: "Breakfast", name: "Maggi", rate: 40, img: "https://placehold.co/100x100/ffcc00/fff?text=Maggi" },
        { cat: "Breakfast", name: "Omlet", rate: 30, img: "https://placehold.co/100x100/ffcc00/fff?text=Egg" },
        { cat: "Breakfast", name: "Spanish Omlette", rate: 40, img: "https://placehold.co/100x100/ffcc00/fff?text=Span" },
        { cat: "Breakfast", name: "Chole Bature", rate: 40, img: "https://placehold.co/100x100/cc6600/fff?text=Chole" },
        { cat: "South Indian", name: "Plain Dosa", rate: 30, img: "https://placehold.co/100x100/cc9966/fff?text=Dosa" },
        { cat: "South Indian", name: "Masala Dosa", rate: 40, img: "https://placehold.co/100x100/cc9966/fff?text=MasDosa" },
        { cat: "South Indian", name: "Idly (2pcs)", rate: 20, img: "https://placehold.co/100x100/ffffff/333?text=Idly" },
        { cat: "Rolls", name: "Veg Roll", rate: 35, img: "https://placehold.co/100x100/009933/fff?text=VRoll" },
        { cat: "Rolls", name: "Egg Roll", rate: 40, img: "https://placehold.co/100x100/cc9900/fff?text=ERoll" },
        { cat: "Rolls", name: "Chicken Roll", rate: 80, img: "https://placehold.co/100x100/cc3300/fff?text=CRoll" },
        { cat: "Sandwich", name: "Cheese Grill Sandwich", rate: 40, img: "https://placehold.co/100x100/ffcc00/fff?text=Sand" },
        { cat: "Sandwich", name: "Chicken Cheese Grill", rate: 70, img: "https://placehold.co/100x100/cc3300/fff?text=ChkSand" },
        { cat: "Starter Veg", name: "Chilly Paneer", rate: 120, img: "https://placehold.co/100x100/cc3300/fff?text=Paneer" },
        { cat: "Starter Veg", name: "Veg Manchurian", rate: 80, img: "https://placehold.co/100x100/009933/fff?text=Manch" },
        { cat: "Starter Veg", name: "Chilli Babycorn", rate: 120, img: "https://placehold.co/100x100/ffff00/fff?text=Corn" },
        { cat: "Starter NonVeg", name: "Chilly Chicken (Half)", rate: 80, img: "https://placehold.co/100x100/cc3300/fff?text=Chilly" },
        { cat: "Starter NonVeg", name: "Chilly Chicken (Full)", rate: 160, img: "https://placehold.co/100x100/cc3300/fff?text=Chilly" },
        { cat: "Starter NonVeg", name: "Chicken 65", rate: 160, img: "https://placehold.co/100x100/cc0000/fff?text=65" },
        { cat: "Starter NonVeg", name: "Chicken Lollipop", rate: 160, img: "https://placehold.co/100x100/cc0000/fff?text=Lolli" },
        { cat: "Main Course Indian", name: "Yellow Dal", rate: 80, img: "https://placehold.co/100x100/ffcc00/333?text=Dal" },
        { cat: "Main Course Indian", name: "Dal Makhani", rate: 120, img: "https://placehold.co/100x100/663300/fff?text=DalM" },
        { cat: "Main Course Indian", name: "Paneer Butter Masala", rate: 160, img: "https://placehold.co/100x100/ff9966/fff?text=PBM" },
        { cat: "Main Course Indian", name: "Butter Chicken", rate: 210, img: "https://placehold.co/100x100/ff9933/fff?text=ButChk" },
        { cat: "Main Course Indian", name: "Chicken Kadhai", rate: 210, img: "https://placehold.co/100x100/cc3300/fff?text=KadChk" },
        { cat: "Biryani", name: "Veg Biryani", rate: 120, img: "https://placehold.co/100x100/009933/fff?text=VegBir" },
        { cat: "Biryani", name: "Chicken Dum Biryani", rate: 160, img: "https://placehold.co/100x100/cc3300/fff?text=CDB" },
        { cat: "Biryani", name: "Mutton Dum Biryani", rate: 250, img: "https://placehold.co/100x100/660000/fff?text=MDB" },
        { cat: "Main Course Chinese", name: "Chowmein (Veg)", rate: 100, img: "https://placehold.co/100x100/eeeeee/333?text=ChowV" },
        { cat: "Main Course Chinese", name: "Chowmein (Chicken)", rate: 160, img: "https://placehold.co/100x100/eeeeee/333?text=ChowC" },
        { cat: "Breads", name: "Tandoori Roti", rate: 20, img: "https://placehold.co/100x100/cc9966/fff?text=Roti" },
        { cat: "Breads", name: "Butter Naan", rate: 20, img: "https://placehold.co/100x100/cc9966/fff?text=BNaan" },
        { cat: "Thali", name: "Veg Thali", rate: 65, img: "https://placehold.co/100x100/009933/fff?text=VThali" },
        { cat: "Thali", name: "Chicken Thali", rate: 100, img: "https://placehold.co/100x100/cc3300/fff?text=CThali" },
    ];

    let CART = [];
    let ACTIVE_CAT = 'All';
    let ACTIVE_DIET = 'all';

    function isVeg(item) {
        const nonVegKeywords = ['chicken', 'mutton', 'egg', 'fish', 'prawn', 'nonveg', 'omlet', 'non-veg'];
        const nameLower = item.name.toLowerCase();
        const catLower = item.cat.toLowerCase();
        if (catLower.includes('nonveg') || catLower.includes('non-veg')) return false;
        for (let kw of nonVegKeywords) { if (nameLower.includes(kw)) return false; }
        return true;
    }

    window.onload = function() {
        renderCategories();
        renderMenu();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expDate').value = today;
        document.getElementById('expTo').value = today;
        document.getElementById('repFrom').value = today.substring(0,8)+"01";
        document.getElementById('repTo').value = today;
        document.getElementById('expFrom').value = today.substring(0,8)+"01";
    };

    function showTab(tab) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('view-sales').style.display = 'none';
        document.querySelectorAll('.generic-view').forEach(el => el.style.display = 'none');
        if(tab === 'sales') {
            document.getElementById('view-sales').style.display = 'flex';
        } else {
            document.getElementById('view-'+tab).style.display = 'block';
            if(tab === 'inventory') loadInventory();
        }
    }

    // Inventory Tab Switching
    function showInvTab(tab) {
        document.querySelectorAll('.inv-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.inv-content-area').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('inv-'+tab).classList.add('active');
    }

    function renderCategories() {
        const cats = ['All', ...new Set(MENU_DB.map(i => i.cat))];
        const container = document.getElementById('catTabs');
        container.innerHTML = cats.map(c => `<div class="cat-tab ${c === 'All' ? 'active' : ''}" onclick="filterCat('${c}', this)"><i class="fas fa-${getIcon(c)}"></i><span>${c}</span></div>`).join('');
    }

    function getIcon(cat) {
        const map = { 'Snacks': 'cookie-bite', 'Soup': 'mug-hot', 'Breakfast': 'egg', 'South Indian': 'utensils', 'Rolls': 'bread-slice', 'Sandwich': 'layer-group', 'Starter Veg': 'leaf', 'Starter NonVeg': 'drumstick-bite', 'Main Course Indian': 'pepper-hot', 'Main Course Chinese': 'box-open', 'Biryani': 'concierge-bell', 'Breads': 'bread-slice', 'Thali': 'utensils', 'Dessert': 'ice-cream' };
        return map[cat] || 'utensils';
    }

    function filterMenu() { renderMenu(); } // ADDED MISSING WRAPPER

    function filterCat(cat, el) {
        ACTIVE_CAT = cat;
        document.getElementById('posSearch').value = '';
        document.querySelectorAll('.cat-tab').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        renderMenu();
    }

    function toggleDiet(type) {
        if (ACTIVE_DIET === type) {
            ACTIVE_DIET = 'all';
            document.getElementById('btnVeg').classList.remove('active');
            document.getElementById('btnNonVeg').classList.remove('active');
        } else {
            ACTIVE_DIET = type;
            document.getElementById('btnVeg').classList.toggle('active', type === 'veg');
            document.getElementById('btnNonVeg').classList.toggle('active', type === 'nonveg');
            if(type === 'veg') document.getElementById('btnNonVeg').classList.remove('active');
            if(type === 'nonveg') document.getElementById('btnVeg').classList.remove('active');
        }
        renderMenu();
    }

    function renderMenu() {
        const term = document.getElementById('posSearch').value.trim().toLowerCase();
        const filtered = MENU_DB.filter(i => {
            const catMatch = (term.length > 0) ? true : (ACTIVE_CAT === 'All' || i.cat === ACTIVE_CAT);
            const searchMatch = i.name.toLowerCase().includes(term);
            let dietMatch = true;
            if (ACTIVE_DIET === 'veg') dietMatch = isVeg(i);
            if (ACTIVE_DIET === 'nonveg') dietMatch = !isVeg(i);
            return catMatch && searchMatch && dietMatch;
        });

        const grid = document.getElementById('menuGrid');
        if(filtered.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; margin-top:20px;">No items found</div>'; return; }

        grid.innerHTML = filtered.map(item => {
            const vegStatus = isVeg(item) ? 'veg' : 'nonveg';
            return `<div class="item-card"><div class="diet-dot ${vegStatus}"></div><img src="${item.img}" class="item-img"><div class="item-title">${item.name}</div><div class="item-desc">${item.cat}</div><div class="item-footer"><div class="item-price">₹${item.rate}</div><button class="add-btn" onclick="addToCart('${item.name}')"><i class="fas fa-plus"></i></button></div></div>`;
        }).join('');
    }

    function addToCart(itemName) {
        const existing = CART.find(i => i.name === itemName);
        if(existing) { existing.qty++; } else { const item = MENU_DB.find(i => i.name === itemName); CART.push({ ...item, qty: 1 }); }
        updateCart();
    }

    function updateQty(name, change) {
        const item = CART.find(i => i.name === name);
        if(item) { item.qty += change; if(item.qty <= 0) CART = CART.filter(i => i.name !== name); updateCart(); }
    }

    function updateCart() {
        const container = document.getElementById('cartItems');
        if(CART.length === 0) {
            container.innerHTML = `<div style="text-align:center; color: #94a3b8; margin-top: 50px;"><i class="fas fa-shopping-basket" style="font-size: 30px; margin-bottom: 10px;"></i><br>Cart is Empty</div>`;
        } else {
            container.innerHTML = CART.map(i => `<div class="cart-item"><img src="${i.img}" class="cart-thumb"><div class="cart-details"><div class="cart-name">${i.name}</div><div class="cart-price">₹${i.rate}</div></div><div class="cart-qty"><button class="qty-btn" onclick="updateQty('${i.name}', -1)">-</button><span>${i.qty}</span><button class="qty-btn" onclick="updateQty('${i.name}', 1)">+</button></div></div>`).join('');
        }

        let subtotal = CART.reduce((sum, i) => sum + (i.rate * i.qty), 0);
        let discount = parseFloat(document.getElementById('discount').value) || 0;
        let taxable = Math.max(0, subtotal - discount);
        let tax = taxable * 0.05;
        let exactTotal = taxable + tax;
        let rounded = Math.round(exactTotal);
        let roundOff = rounded - exactTotal;

        document.getElementById('cart-subtotal').innerText = '₹' + subtotal.toFixed(2);
        document.getElementById('cart-tax').innerText = '₹' + tax.toFixed(2);
        document.getElementById('cart-round').innerText = (roundOff > 0 ? '+' : '') + roundOff.toFixed(2);
        document.getElementById('cart-total').innerText = '₹' + rounded.toFixed(2);
        document.getElementById('final-payable').innerText = '₹' + rounded.toFixed(2);
    }

    function showCheckout() {
        if(CART.length === 0) return alert("Cart is empty");
        document.querySelector('.pos-cart-area').classList.add('show-checkout');
        updateCart();
    }

    function hideCheckout() {
        document.querySelector('.pos-cart-area').classList.remove('show-checkout');
    }

    async function submitOrder() {
        const payload = {
            customerName: document.getElementById('custName').value || 'Walk-in',
            customerMobile: document.getElementById('custMobile').value,
            orderType: document.getElementById('orderType').value,
            paymentMode: document.getElementById('paymentMode').value,
            gstRate: 5.0,
            discount: parseFloat(document.getElementById('discount').value) || 0,
            items: CART.map(i => ({
                quantity: i.qty,
                unit: 'PLATE',
                rate: i.rate,
                dishName: i.name
            }))
        };

        try {
            const res = await fetch(`${API_BASE}/sales`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok || res.status === 200) {
                showReceipt(payload); // Show Receipt
                resetCart();
            } else {
                throw new Error("Backend Error " + res.status);
            }
        } catch(e) {
            console.warn("Backend offline, simulating success for demo.");
            showReceipt(payload);
            resetCart();
        }
    }

    function showReceipt(data) {
        document.getElementById('r-date').innerText = "Date: " + new Date().toLocaleString();
        document.getElementById('r-order-no').innerText = "Order #" + Math.floor(Math.random() * 9000 + 1000);
        document.getElementById('r-cust').innerText = "Cust: " + data.customerName;

        // Use global CART because payload might miss display details if backend offline
        const itemsHtml = CART.map(i =>
            `<div class="r-row">
                <span style="flex:1">${i.name}</span>
                <span style="width:30px; text-align:center">x${i.qty}</span>
                <span style="width:50px; text-align:right">${(i.rate * i.qty).toFixed(2)}</span>
            </div>`
        ).join('');

        document.getElementById('r-items').innerHTML = itemsHtml;
        document.getElementById('r-sub').innerText = document.getElementById('cart-subtotal').innerText;
        document.getElementById('r-tax').innerText = document.getElementById('cart-tax').innerText;
        document.getElementById('r-round').innerText = document.getElementById('cart-round').innerText;
        document.getElementById('r-total').innerText = document.getElementById('cart-total').innerText;

        document.getElementById('receiptModal').style.display = 'flex';
    }

    function closeReceipt() { document.getElementById('receiptModal').style.display = 'none'; }

    function resetCart() {
        CART = [];
        document.getElementById('custName').value = '';
        document.getElementById('custMobile').value = '';
        document.getElementById('discount').value = 0;
        updateCart();
        hideCheckout();
    }

    async function loadInventory() {
        try {
            const res = await fetch(`${API_BASE}/inventory-items`);
            const data = await res.json();
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.id}</td><td>${item.name}</td><td>${item.baseUnit}</td><td>${item.currentStock}</td><td><button class="btn-sm btn-sec">Edit</button></td>`;
                tbody.appendChild(tr);
            });
        } catch(e) { console.warn("Inv load fail"); }
    }

    function createNewItem() { alert("Item Added"); }

    // --- UPDATED EXPENSE AGGREGATION LOGIC ---
    function toggleInvFields() {
        const val = document.getElementById('expCategory').value;
        const invBox = document.getElementById('invFields');
        const amountField = document.getElementById('expAmount');

        if (val === 'Inventory') {
            invBox.style.display = 'block';
            amountField.readOnly = true;
            amountField.style.backgroundColor = '#f1f5f9';
        } else {
            invBox.style.display = 'none';
            amountField.readOnly = false;
            amountField.style.backgroundColor = 'white';
        }
    }

    function calcExp() {
        const q = parseFloat(document.getElementById('invQty').value) || 0;
        const r = parseFloat(document.getElementById('invRate').value) || 0;
        document.getElementById('expAmount').value = (q * r).toFixed(2);
    }

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const cat = document.getElementById('expCategory').value;
        let desc = document.getElementById('expDesc').value;
        const amt = parseFloat(document.getElementById('expAmount').value);

        if (cat === 'Inventory') {
            const qty = document.getElementById('invQty').value;
            const unit = document.getElementById('invUnit').value;
            const rate = document.getElementById('invRate').value;
            desc = `Inventory: ${desc} | Qty: ${qty} ${unit} | Rate: ${rate}`;
        }

        const body = {
            expenseDate: document.getElementById('expDate').value,
            category: cat,
            description: desc,
            amount: amt
        };

        try {
            const res = await fetch(`${API_BASE}/expenses`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                alert('Expense Saved');
                document.getElementById('expenseForm').reset();
                toggleInvFields();
                loadExpenses();
            }
        } catch(e) { alert("Backend Error"); }
    });

    // --- NEW AGGREGATION FUNCTION ---
    async function loadExpenses() {
        const from = document.getElementById('expFrom').value;
        const to = document.getElementById('expTo').value;

        try {
            const res = await fetch(`${API_BASE}/expenses?from=${from}&to=${to}`);
            const data = await res.json();
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';

            // 1. Helper to extract details
            const parseInv = (desc) => {
                if(!desc.startsWith('Inventory:')) return null;
                const parts = desc.split('|');
                const name = parts[0].replace('Inventory:', '').trim();
                const qtyPart = parts[1].replace('Qty:', '').trim().split(' ');
                const qty = parseFloat(qtyPart[0]);
                const unit = qtyPart[1] || '';
                return { name, qty, unit };
            };

            // 2. Aggregation Map
            const grouped = {};
            const normalExpenses = [];

            data.forEach(exp => {
                if(exp.category === 'Inventory') {
                    const details = parseInv(exp.description);
                    if(details) {
                        // Key = Date + Name (e.g., "2023-10-25_Tomato")
                        const key = `${exp.expenseDate}_${details.name.toLowerCase()}`;

                        if(!grouped[key]) {
                            grouped[key] = {
                                date: exp.expenseDate,
                                name: details.name,
                                unit: details.unit,
                                totalQty: 0,
                                totalCost: 0,
                                count: 0
                            };
                        }
                        grouped[key].totalQty += details.qty;
                        grouped[key].totalCost += exp.amount;
                        grouped[key].count++;
                    } else {
                        normalExpenses.push(exp); // Fallback for malformed
                    }
                } else {
                    normalExpenses.push(exp);
                }
            });

            // 3. Render Normal Expenses First
            normalExpenses.forEach(exp => {
                tbody.innerHTML += `
                    <tr>
                        <td>${exp.expenseDate}</td>
                        <td>${exp.category}</td>
                        <td>${exp.description}</td>
                        <td class="col-amount">₹${exp.amount.toFixed(2)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td><button class="btn-action"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });

            // 4. Render Aggregated Inventory Rows
            Object.values(grouped).forEach(item => {
                tbody.innerHTML += `
                    <tr style="background:#fff7ed;">
                        <td style="font-weight:bold; color:#d97706;">${item.date}</td>
                        <td style="font-weight:bold; color:#d97706;">Inventory</td>
                        <td style="font-weight:bold;">${item.name} <span style="font-size:10px; color:#666; font-weight:normal;">(Aggregated ${item.count} entries)</span></td>
                        <td class="col-amount">₹${item.totalCost.toFixed(2)}</td>
                        <td style="font-weight:bold;">${item.totalQty.toFixed(2)} ${item.unit}</td>
                        <td class="col-inv">₹${item.totalCost.toFixed(2)}</td>
                        <td><button class="btn-action"><i class="fas fa-chart-pie"></i></button></td>
                    </tr>`;
            });

        } catch(e) { console.warn("Exp load fail"); }
    }

    async function loadReport() {
        const from = document.getElementById('repFrom').value;
        const to = document.getElementById('repTo').value;
        try {
            const res = await fetch(`${API_BASE}/reports/monthly?from=${from}&to=${to}`);
            const data = await res.json();
            document.getElementById('repSales').innerText = `₹${data.totalSales.toFixed(2)}`;
            document.getElementById('repExp').innerText = `₹${data.totalExpenses.toFixed(2)}`;
            document.getElementById('repProfit').innerText = `₹${data.profit.toFixed(2)}`;
            const detailRes = await fetch(`${API_BASE}/reports/detailed?from=${from}&to=${to}`);
            const details = await detailRes.json();
            renderDetailedReport(details);
        } catch(e) { console.warn("Report load fail", e); }
    }

    function renderDetailedReport(data) {
        const container = document.getElementById('detailed-report-container');
        if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999;">No sales found.</div>';
            return;
        }
        let html = '';
        data.forEach(day => {
            html += `<div style="margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;"><div style="background: #f8fafc; padding: 10px 15px; font-weight: bold; color: var(--primary); display:flex; justify-content:space-between;"><span>${day.date}</span><span>Total: ₹${day.totalRevenue.toFixed(2)} (${day.totalOrders} Orders)</span></div><table class="report-table"><thead><tr><th>Customer</th><th>Type</th><th>Items</th><th style="text-align:right;">Amount</th></tr></thead><tbody>`;
            day.transactions.forEach(txn => {
                html += `<tr><td>${txn.customerName} <span style="font-size:10px; color:#999;">(${txn.paymentMode})</span></td><td><span style="font-size:11px; padding:2px 6px; background:#e0f2fe; color:#0369a1; border-radius:4px;">${txn.orderType}</span></td><td style="color:#64748b; font-size:12px;">${txn.itemsSummary}</td><td style="text-align:right; font-weight:600;">₹${txn.billAmount.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        });
        container.innerHTML = html;
    }
</script>
</body>
</html>